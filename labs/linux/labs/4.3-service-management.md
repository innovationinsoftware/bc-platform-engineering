# Service Management with systemd

Service management is a critical skill for system admini4. Verify httpd i6. Stop the httpd service
```
sudo systemctl stop httpd
```

7. Verify it stoppedening on port 80
```
sudo ss -tlnp | grep httpd
```

5. Test the web serverrs who need to control and monitor services running on Linux systems. Modern Linux distributions use systemd as their service manager, providing commands to start, stop, and check the status of services like web servers, databases, and other background processes.

Understanding how to manage services allows you to deploy applications, troubleshoot issues, and ensure that critical services start automatically when your system boots. Whether you're running a web server or any other service, these basic service management skills are essential.

### Estimated Time: 20 Minutes

## Part 1: Understanding systemctl

1. Create a working directory for this lab
```
mkdir -p ~/service_lab && cd ~/service_lab
```

2. Check the systemd version
```
systemctl --version
```

3. List all running services
```
systemctl list-units --type=service --state=running
```

4. Check the status of the SSH service (allows remote login)
```
systemctl status sshd
```

**Understanding the status output:**
- **Loaded**: Shows if the service is configured
- **Active**: Current state (active/running, inactive, failed)
- **Main PID**: Process ID of the service
- **Recent logs**: Last few log entries

## Part 2: Installing Apache Web Server

1. Install the Apache web server (httpd)
```
sudo dnf install -y httpd
```

2. Verify the installation
```
which httpd
httpd -v
```

3. Check the initial status (should be inactive)
```
systemctl status httpd
```

Notice that the service is installed but not running yet.

## Part 3: Starting and Stopping Services

1. Start the httpd service
```
sudo systemctl start httpd
```

2. Check the status again
```
systemctl status httpd
```

Notice it now shows **active (running)**.

3. Quick look at httpd's cgroups (resource controls)
```
# View cgroup properties with systemctl
systemctl show httpd --property=ControlGroup,CPUQuotaPerSecUSec,MemoryLimit

# Get the service's cgroup path
systemctl status httpd | grep CGroup

# View CPU limits
cat /sys/fs/cgroup/system.slice/httpd.service/cpu.max

# View memory limits  
cat /sys/fs/cgroup/system.slice/httpd.service/memory.max

# View current memory usage
cat /sys/fs/cgroup/system.slice/httpd.service/memory.current
```

**Quick explanation:**
- systemd uses cgroups to manage resource limits for services
- `systemctl show` displays cgroup properties for the service
- `cpu.max` shows CPU quota (unlimited if "max")
- `memory.max` shows memory limit (unlimited if "max")
- `memory.current` shows current memory usage in bytes

3b. Demo cgroups in action with CPU limits
```
# Run a CPU stress command with 15% CPU limit
sudo systemd-run --unit=stress-test --scope -p CPUQuota=15% stress --cpu 1 --timeout 60s &

# press enter

top
```

**What's happening:**
- `systemd-run` creates a temporary systemd unit with cgroup limits
- `CPUQuota=15%` restricts the process to 15% of one CPU core
- The `stress` command tries to max out CPU, but cgroups limit it
- You'll see CPU usage capped around 15% instead of 100%

Note: If `stress` isn't installed, install it with `sudo dnf install -y stress`

4. Verify httpd is listening on port 80
```
sudo ss -tlnp | grep httpd
```

5. Test the web server
```
curl localhost
```

You should see HTML content from Apache's default page.

6. Stop the httpd service
```
sudo systemctl stop httpd
```

6. Verify it stopped
```
systemctl status httpd
```

Now it shows **inactive (dead)**.

## Part 4: Enabling Services to Start at Boot

When you enable a service, it will automatically start when the system boots up.

1. Start httpd again
```
sudo systemctl start httpd
```

2. Check if httpd is enabled to start at boot
```
systemctl is-enabled httpd
```

It should show "disabled".

3. Enable httpd to start automatically at boot
```
sudo systemctl enable httpd
```

4. Verify it's enabled
```
systemctl is-enabled httpd
```

Now it shows "enabled".

5. You can also enable and start in one command
```
sudo systemctl enable --now httpd
```

## Part 5: Restarting Services

Sometimes you need to restart a service after changing its configuration.

1. Restart the httpd service
```
sudo systemctl restart httpd
```

2. Check the status
```
systemctl status httpd
```

Notice the process ID (PID) changed because the service stopped and started again.

## Part 6: Quick Status Checks

These commands are useful for quick checks without viewing full details.

1. Check if a service is active (running)
```
systemctl is-active httpd
```

2. Check if a service is enabled (starts at boot)
```
systemctl is-enabled httpd
```

3. List all failed services
```
systemctl --failed
```

## Part 7: Viewing Service Logs

System logs help you troubleshoot issues with services.

1. View recent logs for httpd
```
sudo journalctl -u httpd -n 20
```

**Flags explained:**
- `-u httpd` - Show logs for the httpd unit
- `-n 20` - Show last 20 lines

2. Follow logs in real-time (like tail -f)
```
sudo journalctl -u httpd -f
```

Press Ctrl+C to stop following.

3. View logs since a specific time
```
sudo journalctl -u httpd --since "5 minutes ago"
```

## Part 8: Viewing Service Configuration

1. View the httpd service unit file
```
systemctl cat httpd
```

This shows the configuration file that defines how systemd manages the service.

**Key sections:**
- **[Unit]** - Description and dependencies
- **[Service]** - How to start, stop, and run the service
- **[Install]** - When and how to enable the service

2. View specific service properties
```
systemctl show httpd -p ExecStart
systemctl show httpd -p MainPID
```

## Part 9: Disabling Services

If you don't want a service to start automatically at boot, disable it.

1. Disable httpd from starting at boot
```
sudo systemctl disable httpd
```

2. Verify it's disabled
```
systemctl is-enabled httpd
```

3. The service is still running, but won't start automatically next boot
```
systemctl is-active httpd
```

4. Stop it completely
```
sudo systemctl stop httpd
```

## Cleanup

1. Stop and disable httpd
```
sudo systemctl stop httpd
sudo systemctl disable httpd
```

2. Verify cleanup
```
systemctl status httpd
```

3. Remove working directory
```
cd ~
rm -rf ~/service_lab
```

## Conclusion

In this lab, you learned essential service management commands:

- **Installing services**: Using `dnf` to install Apache (httpd)
- **Starting/Stopping**: Using `systemctl start` and `systemctl stop`
- **Enabling/Disabling**: Controlling whether services start at boot with `systemctl enable` and `systemctl disable`
- **Checking status**: Using `systemctl status`, `is-active`, and `is-enabled`
- **Viewing logs**: Using `journalctl` to troubleshoot service issues
- **Restarting**: Using `systemctl restart` after configuration changes

These fundamental commands allow you to manage any service on a Linux system. Whether you're running a web server, database, or any other application, you'll use these same systemctl commands to control them.

## Common systemctl Commands Reference

```
sudo systemctl start <service>      # Start a service
sudo systemctl stop <service>       # Stop a service
sudo systemctl restart <service>    # Restart a service
sudo systemctl enable <service>     # Enable service at boot
sudo systemctl disable <service>    # Disable service at boot
sudo systemctl status <service>     # View detailed status
systemctl is-active <service>       # Check if running
systemctl is-enabled <service>      # Check if enabled at boot
sudo journalctl -u <service>        # View service logs
```
